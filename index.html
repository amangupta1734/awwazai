<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Awwazai - AI Transcription & Summarization</title>

    <script src="https://cdn.tailwindcss.com"></script>

<script>
function logout() {
    localStorage.removeItem('auth_token');
    localStorage.removeItem('user_email');
    sessionStorage.removeItem('auth_token');
    sessionStorage.removeItem('user_email');
    window.location.href = '/login.html';
}

function checkAuth() {
    const token = localStorage.getItem('auth_token') ||
                  sessionStorage.getItem('auth_token');
    if (!token) {
        window.location.href = '/login.html';
    }
}

checkAuth();
</script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #4B5563; }
        .nav-link.active { background-color: #4f46e5; color: #ffffff; }
        .transcript-box { height: 300px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word; line-height: 1.6; }
        .text-speaker-1 { color: #818CF8; }
        .text-speaker-2 { color: #A7F3D0; }
        .text-speaker-3 { color: #FCD34D; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

<div class="flex h-screen">
    <aside class="w-64 flex-shrink-0 bg-gray-800 p-6 flex flex-col justify-between">
        <div>
            <div class="flex items-center mb-10">
                <svg class="w-8 h-8 mr-3 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                </svg>
                <h1 class="text-2xl font-bold text-white">Awwazai</h1>
            </div>
            <nav class="space-y-3">
                <a href="#" class="nav-link active flex items-center py-3 px-4 rounded-lg hover:bg-gray-700" data-target="dashboard-view">
                    <svg class="w-6 h-6 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                    </svg>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="nav-link flex items-center py-3 px-4 rounded-lg hover:bg-gray-700" data-target="new-transcript-view">
                    <svg class="w-6 h-6 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    <span>New Transcript</span>
                </a>
            </nav>
        </div>
        <div class="mt-auto border-t border-gray-700 pt-4">
            <div class="flex items-center group mb-4">
                <img class="h-10 w-10 rounded-full object-cover" src="https://placehold.co/100x100/7c3aed/ffffff?text=User" alt="User Avatar">
                <div class="ml-3 flex-1">
                    <p class="text-sm font-medium text-white">Aman </p>
                    <p class="text-xs font-medium text-gray-400 group-hover:text-gray-300">Final Year Project</p>
                </div>
            </div>
            <button 
                onclick="logout()"
                class="w-full flex items-center justify-center px-4 py-2 bg-gray-700 hover:bg-red-600 text-gray-300 hover:text-white rounded-lg transition duration-200 group">
                <svg class="w-5 h-5 mr-2 group-hover:rotate-180 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                </svg>
                <span class="font-medium">Logout</span>
            </button>
        </div>
    </aside>

    <main class="flex-1 p-8 overflow-y-auto">
        <div id="dashboard-view">
            <h2 class="text-3xl font-bold mb-8">Dashboard</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                   <div class="bg-gray-800 p-6 rounded-xl flex items-center">
                    <div class="bg-indigo-600 p-3 rounded-lg mr-4">
                       <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path></svg>
                    </div>
                    <div><p class="text-sm text-gray-400">Total Meetings</p><p class="text-2xl font-bold" id="total-meetings">--</p></div>
                </div>
                <div class="bg-gray-800 p-6 rounded-xl flex items-center">
                    <div class="bg-green-600 p-3 rounded-lg mr-4">
                       <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <div><p class="text-sm text-gray-400">Total Duration</p><p class="text-2xl font-bold" id="total-duration">--</p></div>
                </div>
                <div class="bg-gray-800 p-6 rounded-xl flex items-center">
                    <div class="bg-yellow-500 p-3 rounded-lg mr-4">
                       <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    </div>
                    <div><p class="text-sm text-gray-400">Meetings This Week</p><p class="text-2xl font-bold" id="this-week">--</p></div>
                </div>
                <div class="bg-gray-800 p-6 rounded-xl flex items-center">
                    <div class="bg-red-500 p-3 rounded-lg mr-4">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <div><p class="text-sm text-gray-400">Completed</p><p class="text-2xl font-bold" id="completed">--</p></div>
                </div>
            </div>

            <div>
                <div class="flex items-center gap-3 mb-4">
                    <h3 class="text-xl font-bold">Meeting History</h3>
                    <div class="flex-1 relative max-w-md">
                        <input id="search-input" type="text" placeholder="Search meetings, transcripts, speakers..."
                            class="w-full bg-gray-700 border border-gray-600 rounded-lg pl-9 pr-4 py-2 text-sm text-white placeholder-gray-400 focus:outline-none focus:border-indigo-500 transition"/>
                        <svg class="absolute left-3 top-2.5 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        <button id="search-clear" onclick="clearSearch()" class="hidden absolute right-3 top-2.5 text-gray-400 hover:text-white">‚úï</button>
                    </div>
                    <span id="search-results-count" class="text-xs text-gray-400 hidden"></span>
                </div>
                <div class="bg-gray-800 rounded-xl overflow-hidden shadow-lg">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="border-b border-gray-700">
                                <tr>
                                    <th class="p-4 font-semibold">Title</th>
                                    <th class="p-4 font-semibold">Date</th>
                                    <th class="p-4 font-semibold">Duration</th>
                                    <th class="p-4 font-semibold">Language</th>
                                    <th class="p-4 font-semibold">Status</th>
                                    <th class="p-4 font-semibold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recent-transcripts-body">
                                
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="detail-modal-container" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden items-center justify-center p-4">
                <div id="detail-modal" class="bg-gray-800 w-full max-w-4xl max-h-[90vh] overflow-y-auto p-6 rounded-xl shadow-2xl relative">
                    <button onclick="hideModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                    <h3 id="modal-title" class="text-2xl font-bold text-indigo-400 mb-4">Meeting Details</h3>
                    <div class="flex gap-3 mb-4">
    <button id="download-transcript-btn"
        class="px-4 py-2 text-sm bg-gray-700 hover:bg-gray-600 rounded-lg">
        üìÑ Download Transcript
    </button>
    <button id="export-pdf-btn"
        class="px-4 py-2 text-sm bg-indigo-600 hover:bg-indigo-700 rounded-lg text-white">
        üì• Export Summary (PDF)
    </button>
</div>

                    <div class="space-y-6">
                        <div class="bg-gray-700 p-4 rounded-lg">
                            <div class="flex gap-2 mb-3">
    <select id="translate-lang" class="bg-gray-700 text-sm rounded px-2 py-1">
        <option value="en">English</option>
        <option value="hi">Hindi</option>
        <option value="mr">Marathi</option>
        <option value="es">Spanish</option>
        <option value="fr">French</option>
    </select>
    <button id="translate-btn"
        class="px-3 py-1 text-sm bg-indigo-600 hover:bg-indigo-700 rounded text-white">
        Translate Summary
    </button>
</div>

                            <h4 class="text-xl font-semibold mb-2">AI Summary</h4>
                            <p id="modal-summary" class="text-gray-300 italic"></p>
                        </div>

                        <div class="bg-gray-700 p-4 rounded-lg">
                            <h4 class="text-xl font-semibold mb-2">Action Items</h4>
                            <div id="modal-actions" class="text-gray-300 space-y-2"></div>
                        </div>

                        <!-- Speaker Labels -->
                        <div class="bg-gray-700 p-4 rounded-lg" id="speaker-labels-section">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="text-xl font-semibold">Speaker Labels</h4>
                                <button onclick="saveSpeakerLabels()" id="save-speakers-btn"
                                    class="hidden px-3 py-1 text-xs bg-green-600 hover:bg-green-700 rounded text-white font-medium">
                                    Save Names
                                </button>
                            </div>
                            <p class="text-xs text-gray-400 mb-3">Click any speaker label in the transcript to give them a real name.</p>
                            <div id="speaker-labels-container" class="flex flex-wrap gap-2"></div>
                        </div>

                        <div class="bg-gray-700 p-4 rounded-lg">
                            <h4 class="text-xl font-semibold mb-2">Full Transcript</h4>
                            <div class="flex gap-2 mb-2">
    <select id="translate-transcript-lang"
            class="bg-gray-700 text-sm rounded px-2 py-1">
        <option value="en">English</option>
        <option value="hi">Hindi</option>
        <option value="mr">Marathi</option>
        <option value="es">Spanish</option>
        <option value="fr">French</option>
    </select>

    <button id="translate-transcript-btn"
            class="px-3 py-1 text-sm bg-indigo-600 hover:bg-indigo-700 rounded text-white">
        Translate Transcript
    </button>
</div>
                            <div id="modal-transcript" class="transcript-box max-h-[400px] text-gray-300 text-sm p-2 rounded"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        

        <div id="new-transcript-view" class="hidden">
            <h2 class="text-3xl font-bold mb-2">Live Meeting Transcription</h2>
            <p class="text-gray-400 mb-8">Click the microphone to start real-time transcription.</p>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                        <div class="flex justify-between items-center">
                            <h3 class="text-2xl font-bold text-white">Start New Session</h3>
                            <span id="status-indicator" class="text-xs px-3 py-1 rounded-full font-medium bg-gray-700 text-gray-300">Ready</span>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
    <h3 class="text-xl font-bold text-white mb-3">Upload Audio / Video</h3>

    <input type="file" id="upload-input"
           accept="audio/*,video/*"
           class="block w-full text-sm text-gray-300
                  file:mr-4 file:py-2 file:px-4
                  file:rounded file:border-0
                  file:text-sm file:font-semibold
                  file:bg-indigo-600 file:text-white
                  hover:file:bg-indigo-700"/>

    <button type="button"
        onclick="uploadFile()"
        class="w-full mt-4 py-2 px-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg">
    Upload & Summarize
</button>


    <p id="upload-status" class="mt-2 text-xs text-gray-400"></p>
</div>

                        <button id="mic-toggle-btn" class="w-full mt-4 py-3 px-6 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg" onclick="toggleMicrophone()">
                            Start Real-Time Transcription
                        </button>
                        <p id="meeting-details" class="mt-4 text-xs text-gray-500 truncate">Current Meeting ID: N/A</p>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 shadow-lg">
                        <h2 class="text-xl font-semibold text-white mb-4">Live Transcription Feed</h2>
                        <div id="transcript-output" class="transcript-box bg-gray-900 p-4 rounded-lg text-gray-400 text-sm border border-gray-700 shadow-inner">
                            <p class="text-gray-600">Press Start to capture audio...</p>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                        <h3 class="text-xl font-semibold text-white mb-3 flex items-center">AI Insights</h3>
                        <div id="summary-area" class="text-sm text-gray-300">
                            <p id="summary-text" class="italic text-gray-500">Summary will appear after recording stops.</p>
                            <div id="action-items-list" class="mt-4 space-y-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
function getAuthHeaders() {
    const token = localStorage.getItem('auth_token') ||
                  sessionStorage.getItem('auth_token');

    if (!token) {
        window.location.href = "/login.html";
        return null;  // caller must check for null
    }

    return { "Authorization": "Bearer " + token };
}

function getAuthHeadersOrNull() {
    // Returns headers or null without redirecting ‚Äî safe for conditional use
    const token = localStorage.getItem('auth_token') ||
                  sessionStorage.getItem('auth_token');
    if (!token) return null;
    return { "Authorization": "Bearer " + token };
}

// --- CONFIGURATION ---
// Use absolute paths to 127.0.0.1 (localhost)
const WEBSOCKET_URL = `${window.location.origin.replace("http", "ws")}/ws/audio`;
const API_BASE_URL = window.location.origin;

// --- GLOBAL STATE ---
let socket, isRecording=false, mediaRecorder, audioStream;
let currentMeetingId=null;
let allMeetings = []; // Store all meetings for the modal
let speakerMap = {};
let speakerCount = 0;
let originalSummary = "";
let originalTranscript = "";



// --- DOM ELEMENTS ---
const navLinks=document.querySelectorAll('.nav-link');
const views = document.querySelectorAll('#dashboard-view, #new-transcript-view');
const recentTranscriptsBody=document.getElementById('recent-transcripts-body');
const btn=document.getElementById('mic-toggle-btn');
const statusIndicator=document.getElementById('status-indicator');
const transcriptOutput=document.getElementById('transcript-output');
const summaryText=document.getElementById('summary-text');
const actionItemsList=document.getElementById('action-items-list');
const meetingDetails=document.getElementById('meeting-details');
// Modal Elements
const detailModalContainer = document.getElementById('detail-modal-container');
const modalTitle = document.getElementById('modal-title');
const modalSummary = document.getElementById('modal-summary');
const modalActions = document.getElementById('modal-actions');
const modalTranscript = document.getElementById('modal-transcript');
const downloadTranscriptBtn = document.getElementById('download-transcript-btn');
const exportPdfBtn = document.getElementById('export-pdf-btn');

// --- UI FUNCTIONS ---
function updateStatus(text,colorClass){statusIndicator.textContent=text;statusIndicator.className=`text-xs px-3 py-1 rounded-full font-medium ${colorClass}`;}
function updateButton(isRec){if(isRec){btn.textContent='Stop & Summarize Meeting';btn.classList.replace('bg-indigo-600','bg-red-600');btn.classList.replace('hover:bg-indigo-700','hover:bg-red-700');}else{btn.textContent='Start Real-Time Transcription';btn.classList.replace('bg-red-600','bg-indigo-600');btn.classList.replace('hover:bg-red-700','hover:bg-indigo-700');}btn.disabled=false;}
function clearSummary(){summaryText.textContent='Summary will be generated once the recording stops and the full transcript is available.';summaryText.classList.add('italic','text-gray-500');actionItemsList.innerHTML='';const badge=document.getElementById('live-lang-badge');if(badge)badge.remove();}

function showLiveLanguageBadge(label, isMixed) {
    // Remove any existing badge
    const existing = document.getElementById('live-lang-badge');
    if (existing) existing.remove();

    const summaryArea = document.getElementById('summary-area');
    const badge = document.createElement('div');
    badge.id = 'live-lang-badge';
    badge.className = 'flex items-center gap-2 mb-3 p-2 rounded-lg ' +
        (isMixed ? 'bg-purple-900/40 border border-purple-500/40' : 'bg-indigo-900/40 border border-indigo-500/40');
    badge.innerHTML = `
        <svg class="w-4 h-4 ${isMixed ? 'text-purple-400' : 'text-indigo-400'} flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path>
        </svg>
        <div>
            <p class="text-xs font-semibold ${isMixed ? 'text-purple-300' : 'text-indigo-300'}">
                ${isMixed ? 'üîÄ Mixed Language Detected' : 'üåê Language Detected'}
            </p>
            <p class="text-xs text-gray-300">${label}</p>
        </div>
    `;
    summaryArea.insertBefore(badge, summaryArea.firstChild);
}


function getSpeakerClass(speaker) {
    // This function creates a simple color rotation for speakers
    if (!speaker) speaker = "SPEAKER"; // Handle partials without speaker
    if (!speakerMap[speaker]) {
        speakerCount++;
        const colorIndex = (speakerCount % 3) + 1;
        speakerMap[speaker] = `text-speaker-${colorIndex}`;
    }
    return speakerMap[speaker];
}

function appendTranscript(text) {
    // Regex to parse labels like (EN): or (HI):
    const match = text.match(/\((.*?)\):\s(.*)/i);
    let displayHtml;

    if (match) {
        const type = match[1];
        const spokenText = match[2];
        const speakerClass = getSpeakerClass(type);
        
        displayHtml = `<div class="mt-2 text-gray-300">
                            <span class="font-bold ${speakerClass}">${type}:</span> 
                            <span class="text-gray-400">${spokenText}</span>
                        </div>`;
    } else {
        // Fallback for other messages (like errors)
        displayHtml = `<div class="mt-2 text-red-400 font-semibold">${text}</div>`;
    }

    transcriptOutput.innerHTML += displayHtml;
    transcriptOutput.scrollTop = transcriptOutput.scrollHeight;
}


// --- VIEW SWITCHING ---
function switchView(targetId){
    views.forEach(v=>v.id===targetId?v.classList.remove('hidden'):v.classList.add('hidden'));
    navLinks.forEach(l=>l.dataset.target===targetId?l.classList.add('active'):l.classList.remove('active'));
    if (targetId === 'dashboard-view') {
        loadMeetingHistory();
    }
}
navLinks.forEach(link=>link.addEventListener('click', (e) => {
    e.preventDefault();
    switchView(link.dataset.target);
}));


function renderMeetingRows(meetings) {
    recentTranscriptsBody.innerHTML = '';
    if (!meetings || meetings.length === 0) {
        recentTranscriptsBody.innerHTML = '<tr class="text-gray-400"><td colspan="6" class="p-4 text-center">No meetings found.</td></tr>';
        return;
    }
    const sorted = [...meetings].sort((a,b) => new Date(b.start_time) - new Date(a.start_time));
    sorted.forEach(meeting => {
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-700 hover:bg-gray-700 cursor-pointer transition-colors';
        const duration = formatDuration(meeting.duration_seconds);
        const statusClass =
            meeting.status === 'COMPLETED' ? 'bg-green-500/20 text-green-300' :
            meeting.status === 'TRANSCRIBING' ? 'bg-blue-500/20 text-blue-300' :
            meeting.status === 'SUMMARIZING' ? 'bg-purple-500/20 text-purple-300' :
            meeting.status === 'PROCESSING' ? 'bg-yellow-500/20 text-yellow-300 animate-pulse' :
            meeting.status === 'FAILED' ? 'bg-red-500/20 text-red-300' :
            'bg-gray-500/20 text-gray-300';
        const meetingDate = new Date(meeting.start_time);
        row.innerHTML = `
            <td class="p-4">
                <div class="flex items-center gap-2">
                    <span class="font-medium">${meeting.title}</span>
                    <button class="text-gray-400 hover:text-indigo-400" title="Rename"
                        onclick="renameMeeting(event, ${meeting.meeting_id}, '${meeting.title.replace(/'/g, "\\'")}')">‚úèÔ∏è</button>
                </div>
            </td>
            <td class="p-4">${meetingDate.toLocaleDateString()}</td>
            <td class="p-4">${duration}</td>
            <td class="p-4">${renderLanguageBadge(meeting.detected_language, meeting.detected_language_codes)}</td>
            <td class="p-4"><span class="text-xs font-medium px-2 py-1 rounded-full ${statusClass}">${meeting.status}</span></td>
            <td class="p-4 flex items-center gap-3">
                <button class="text-indigo-400 hover:text-indigo-300 text-sm font-medium"
                    onclick="viewMeetingDetails(event, ${meeting.meeting_id})">View</button>
                <button class="text-red-400 hover:text-red-300" title="Delete"
                    onclick="deleteMeeting(event, ${meeting.meeting_id})">üóëÔ∏è</button>
            </td>`;
        recentTranscriptsBody.appendChild(row);
    });
}

// --- DATA FETCHING ---
function formatDuration(seconds) {
    if (seconds === undefined || seconds === null) return 'N/A';
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${minutes}m ${remainingSeconds}s`;
}

async function loadMeetingHistory(){
    try{
        const headers = getAuthHeaders();
        if (!headers || !headers['Authorization']) return;

        const resp = await fetch(`${API_BASE_URL}/meetings`, { headers });

        if (resp.status === 401) {
            window.location.href = '/login.html';
            return;
        }
        if (!resp.ok) {
            throw new Error(`HTTP ${resp.status} - ${resp.statusText}`);
        }
        allMeetings = await resp.json(); // Store meetings globally
        
        recentTranscriptsBody.innerHTML='';
        let totalDuration = 0;
        let completedCount = 0;
        let weekCount = 0;
        const oneWeekAgo = new Date();
        oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

        // Render the table rows via shared function (also used by search)
        renderMeetingRows(allMeetings);

        // Compute stats
        allMeetings.forEach(meeting => {
            const meetingDate = new Date(meeting.start_time);
            if (meeting.duration_seconds) totalDuration += meeting.duration_seconds;
            if (meeting.status === 'COMPLETED') completedCount++;
            if (meetingDate > oneWeekAgo) weekCount++;
        });
        // Update dashboard cards
        document.getElementById('total-meetings').textContent = allMeetings.length;
        document.getElementById('total-duration').textContent = formatDuration(totalDuration);
        document.getElementById('this-week').textContent = weekCount;
        document.getElementById('completed').textContent = completedCount;

    } catch(err){
        console.error("Failed to load meeting history:", err);
        recentTranscriptsBody.innerHTML = `<tr class="text-red-400"><td colspan="6" class="p-4 text-center">
            Failed to load meetings: ${err.message}. Check the browser console for details.
        </td></tr>`;
    }
}
// Initial load
document.addEventListener('DOMContentLoaded', () => {
    // Small delay to ensure auth token is available from storage
    setTimeout(() => switchView('dashboard-view'), 50);
});


// --- WEBSOCKET & MICROPHONE LOGIC ---
async function toggleMicrophone(){
    if(!isRecording){
        btn.disabled=true;
        clearSummary();
        transcriptOutput.innerHTML = '<p class="text-gray-600">Connecting to server...</p>';
        speakerMap = {}; // Reset speaker colors
        speakerCount = 0;

        try {
    audioStream = await navigator.mediaDevices.getDisplayMedia({
        video: { frameRate: 1 },
        audio: {
            echoCancellation: false,
            noiseSuppression: false,
            autoGainControl: false
        }
    });
} catch (err) {
    console.error('Error capturing tab/system audio:', err);
    transcriptOutput.innerHTML = `
        <p class="text-red-400">
            Please select a <b>Chrome Tab</b> and enable <b>"Share tab audio"</b>.
        </p>`;
    btn.disabled = false;
    return;
}



        // --- Original MediaRecorder line (no explicit codecs, relying on browser default) ---
        mediaRecorder = new MediaRecorder(audioStream);
        // If you need more control, a more advanced AudioContext + ScriptProcessorNode setup would be used here.

        socket = new WebSocket(WEBSOCKET_URL);
        socket.binaryType = 'arraybuffer';

        socket.onopen = () => {
            updateStatus('Recording...', 'bg-green-600 text-white');
            transcriptOutput.innerHTML = '<p class="text-gray-600">Audio stream connected. Listening...</p>';
            mediaRecorder.start(1000); // Send 1-second chunks
        }
        
        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if(data.type==='INIT'){
                currentMeetingId=data.meetingId;
                meetingDetails.textContent=`Current Meeting ID: ${currentMeetingId}`;
            }
            if(data.type==='TRANSCRIPT_UPDATE'){
                if (transcriptOutput.querySelector('.text-gray-600')) {
                    transcriptOutput.innerHTML = ''; // Clear "Listening..." message
                }
                appendTranscript(data.text);
            }
            if(data.type==='TRANSCRIPT_FINALIZED'){
                // This message type is no longer used, summary comes in real-time
            }
            if(data.type==='LANGUAGE_DETECTED'){
                // Show detected language badge in the live view
                showLiveLanguageBadge(data.label, data.is_mixed);
            }
            if(data.type==='SUMMARY_COMPLETED'){
                // Show language badge if included in summary payload
                if (data.detected_language) {
                    showLiveLanguageBadge(data.detected_language.label, data.detected_language.is_mixed);
                }
                summaryText.textContent=data.summaryData.summary;
                summaryText.classList.remove('italic','text-gray-500');
                actionItemsList.innerHTML='';
                if (data.summaryData.action_items && data.summaryData.action_items.length > 0) {
                    data.summaryData.action_items.forEach(ai=>{
                        const div = document.createElement('div');
                        div.className = 'flex items-start text-sm bg-gray-700 p-3 rounded-md border border-indigo-500/50';
                        div.innerHTML = `
                            <span class="mr-3 mt-1 text-indigo-400 font-bold flex-shrink-0">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                            </span>
                            <div>
                                <p class="font-medium text-white">${ai.item}</p>
                                <p class="text-xs text-gray-400">Assigned to: ${ai.assigned_to || "Team"}</p>

                            </div>
                        `;
                        actionItemsList.appendChild(div);
                    });
                } else {
                    actionItemsList.innerHTML = '<p class="text-gray-500 text-sm">No action items were identified.</p>';
                }
            }
        }

        socket.onclose = (event) => {
            console.log("WebSocket disconnected:", event.reason);
            updateStatus('Disconnected', 'bg-gray-700 text-gray-300');
            if (isRecording) { // If it was an unexpected close
                mediaRecorder.stop();
            }
        };

        socket.onerror = (error) => {
            console.error("WebSocket error:", error);
            transcriptOutput.innerHTML = '<p class="text-red-400">Error connecting to WebSocket. Is the server running?</p>';
            updateStatus('Error', 'bg-red-700 text-red-400');
            if (isRecording) {
                mediaRecorder.stop();
            }
        };

        mediaRecorder.ondataavailable = e => {
            if(e.data.size>0 && socket.readyState===WebSocket.OPEN){
                e.data.arrayBuffer().then(buf => socket.send(buf));
            }
        }
        
        mediaRecorder.onstop = () => {
    if (audioStream) {
        audioStream.getTracks().forEach(track => track.stop());
    }
    updateButton(false);
    updateStatus('Ready','bg-gray-700 text-gray-300');
    loadMeetingHistory();
}

        
        isRecording=true;
        updateButton(true);

    } else {
    mediaRecorder.stop();
    isRecording = false;
}

}

// --- LANGUAGE BADGE HELPERS ---
function renderLanguageBadge(label, codesJson) {
    if (!label) return '<span class="text-xs text-gray-500">‚Äî</span>';

    let codes = [];
    try { codes = codesJson ? JSON.parse(codesJson) : []; } catch(e) {}
    const isMixed = codes.length > 1;

    const colorClass = isMixed
        ? 'bg-purple-900/40 text-purple-300 border border-purple-500/40'
        : 'bg-indigo-900/40 text-indigo-300 border border-indigo-500/40';
    const icon = isMixed ? 'üîÄ' : 'üåê';

    return `<span class="text-xs px-2 py-1 rounded-full font-medium ${colorClass}">${icon} ${label}</span>`;
}

// --- MODAL FUNCTIONS ---
function viewMeetingDetails(event, meetingId) {
    event.stopPropagation(); // Stop row click from firing
    
    const meeting = allMeetings.find(m => m.meeting_id === meetingId);
    if (!meeting) {
        // Simple alert for error, as this is a non-critical part of the demo
        console.error("Could not find meeting details for ID:", meetingId);
        return;
    }
    // Populate Modal
    modalTitle.textContent = meeting.title;

    // Show detected language badge below the title
    const existingLangBadge = document.getElementById('modal-lang-badge');
    if (existingLangBadge) existingLangBadge.remove();
    if (meeting.detected_language) {
        const langBadgeDiv = document.createElement('div');
        langBadgeDiv.id = 'modal-lang-badge';
        langBadgeDiv.className = 'mb-4';
        langBadgeDiv.innerHTML = renderLanguageBadge(meeting.detected_language, meeting.detected_language_codes);
        modalTitle.insertAdjacentElement('afterend', langBadgeDiv);
    }

    // Set summary text and capture original for translate feature
    const summaryContent = meeting.summary_text || '';
    modalSummary.textContent = summaryContent || 'Summary not available.';
    originalSummary = summaryContent;
    modalSummary.classList.toggle('italic', !summaryContent);

    // Parse speaker labels for this meeting
    currentModalMeetingId = meeting.meeting_id;
    currentSpeakerLabels = {};
    if (meeting.speaker_labels) {
        try { currentSpeakerLabels = JSON.parse(meeting.speaker_labels); } catch(e) {}
    }

    // Render transcript with speaker names highlighted + clickable
    originalTranscript = meeting.full_transcript || "";
    renderTranscriptWithNames(originalTranscript, currentSpeakerLabels);

    // Render speaker label editor
    const speakers = extractSpeakersFromTranscript(originalTranscript);
    renderSpeakerLabels(speakers, currentSpeakerLabels);


    
    modalActions.innerHTML = '';
    if (meeting.action_items && meeting.action_items.length > 2) { // Check for empty JSON "[]"
        try {
            const actions = JSON.parse(meeting.action_items);
            if (actions.length > 0) {
                actions.forEach(a => {
                    modalActions.innerHTML += `
                        <div class="flex items-start text-sm">
                            <span class="mr-3 mt-1 text-indigo-400 font-bold">&#9679;</span>
                            <p class="text-white">${a.item} <span class="text-gray-400">(${a.assigned_to})</span></p>
                        </div>
                    `;
                });
            } else {
                modalActions.innerHTML = '<p class="text-gray-500">No action items were identified.</p>';
            }
        } catch(e) {
            console.error("Error parsing action items:", e);
            modalActions.innerHTML = '<p class="text-red-400">Error loading action items.</p>';
        }
    } else {
        modalActions.innerHTML = '<p class="text-gray-500">No action items were identified.</p>';
    }
downloadTranscriptBtn.onclick = () =>
    window.open(`${API_BASE_URL}/meetings/${meetingId}/transcript`, "_blank");

exportPdfBtn.onclick = () =>
    window.open(`${API_BASE_URL}/meetings/${meetingId}/pdf`, "_blank");

document.getElementById("translate-transcript-btn").onclick = async () => {
    const lang = document.getElementById("translate-transcript-lang").value;

    if (!originalTranscript.trim()) {
        modalTranscript.innerHTML = '<p class="text-red-400 italic">No transcript available to translate.</p>';
        return;
    }

    modalTranscript.innerText = "Translating transcript...";

    try {
        const resp = await fetch(`${API_BASE_URL}/translate`, {
            method: "POST",
            headers: {
                ...(getAuthHeaders() || {}),
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ text: originalTranscript, lang: lang })
        });
        const data = await resp.json();
        modalTranscript.innerText = data.translated;
    } catch(e) {
        modalTranscript.innerHTML = '<p class="text-red-400 italic">Translation failed. Please try again.</p>';
    }
};


document.getElementById("translate-btn").onclick = async () => {
    const lang = document.getElementById("translate-lang").value;

    if (!originalSummary.trim()) {
        modalSummary.textContent = 'No summary available to translate.';
        modalSummary.classList.add('italic', 'text-red-400');
        return;
    }

    modalSummary.textContent = "Translating...";
    modalSummary.classList.add('italic', 'text-gray-400');

    try {
        const resp = await fetch(`${API_BASE_URL}/translate`, {
            method: "POST",
            headers: {
                ...(getAuthHeaders() || {}),
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ text: originalSummary, lang: lang })
        });
        const data = await resp.json();
        modalSummary.textContent = data.translated;
        modalSummary.classList.remove('italic', 'text-gray-400', 'text-red-400');
    } catch(e) {
        modalSummary.textContent = 'Translation failed. Please try again.';
        modalSummary.classList.add('italic', 'text-red-400');
    }
};


    // Show Modal
    detailModalContainer.classList.remove('hidden');
    detailModalContainer.classList.add('flex');
}

function hideModal() {
    detailModalContainer.classList.add('hidden');
    detailModalContainer.classList.remove('flex');
}
async function deleteMeeting(event, meetingId) {
    event.stopPropagation();

    if (!confirm("Are you sure you want to delete this meeting?")) return;

    const resp = await fetch(`${API_BASE_URL}/meetings/${meetingId}`, {
        method: "DELETE",
        headers: getAuthHeaders() || {}
    });

    if (resp.ok) {
        loadMeetingHistory();
    } else {
        alert("Failed to delete meeting.");
    }
}

async function renameMeeting(event, meetingId, currentTitle) {
    event.stopPropagation();

    const newTitle = prompt("Enter new meeting name:", currentTitle);
    if (!newTitle || newTitle.trim() === "") return;

    const resp = await fetch(`${API_BASE_URL}/meetings/${meetingId}`, {
        method: "PUT",
        headers: {
            ...(getAuthHeaders() || {}),
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ title: newTitle })
    });

    if (resp.ok) {
        loadMeetingHistory();
    } else {
        alert("Failed to rename meeting.");
    }
}
async function uploadFile() {
    const input = document.getElementById("upload-input");
    const status = document.getElementById("upload-status");

    if (!input.files.length) {
        alert("Please select a file first.");
        return;
    }

    const file = input.files[0];
    const formData = new FormData();
    formData.append("file", file);

    status.innerHTML = '<span class="animate-pulse">‚è≥ Uploading...</span>';

    try {
        const resp = await fetch(`${API_BASE_URL}/upload`, {
            method: "POST",
            headers: getAuthHeaders() || {},
            body: formData
        });

        if (!resp.ok) throw new Error("Upload failed");

        const data = await resp.json();
        // Server returns immediately ‚Äî meeting is PROCESSING in background
        const meetingId = data.meeting_id;

        status.innerHTML = '‚úÖ Upload received! Transcribing and summarizing in background...';
        loadMeetingHistory();
        switchView("dashboard-view");

        // Poll until COMPLETED or FAILED
        pollMeetingStatus(meetingId);

    } catch (err) {
        console.error(err);
        status.textContent = "Error uploading file.";
    }
}

function pollMeetingStatus(meetingId) {
    const maxAttempts = 60; // 5 minutes max (5s intervals)
    let attempts = 0;

    const interval = setInterval(async () => {
        attempts++;
        if (attempts > maxAttempts) {
            clearInterval(interval);
            return;
        }

        try {
            // Reload meeting list ‚Äî it will show updated status
            await loadMeetingHistory();

            // Check if the specific meeting is done
            const meeting = allMeetings.find(m => m.meeting_id === meetingId);
            if (meeting && (meeting.status === "COMPLETED" || meeting.status === "FAILED")) {
                clearInterval(interval);
                if (meeting.status === "COMPLETED" && meeting.full_transcript) {
                    showSpeakerPopup(meetingId, meeting.full_transcript);
                }
            }
        } catch(e) {
            // silently ignore poll errors
        }
    }, 5000); // poll every 5 seconds
}



// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FEATURE: SEARCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let searchTimeout = null;
let isSearchActive = false;

document.getElementById('search-input').addEventListener('input', function() {
    const q = this.value.trim();
    const clearBtn = document.getElementById('search-clear');
    clearBtn.classList.toggle('hidden', q.length === 0);

    clearTimeout(searchTimeout);
    if (q.length === 0) {
        clearSearch();
        return;
    }
    if (q.length < 2) return;

    searchTimeout = setTimeout(() => runSearch(q), 350); // debounce
});

async function runSearch(q) {
    isSearchActive = true;
    document.getElementById('search-results-count').classList.remove('hidden');
    document.getElementById('search-results-count').textContent = 'Searching...';

    try {
        const resp = await fetch(`${API_BASE_URL}/search?q=${encodeURIComponent(q)}`, {
            headers: getAuthHeaders() || {}
        });
        const results = await resp.json();

        allMeetings = results; // swap displayed list
        renderMeetingRows(results);

        const count = results.length;
        document.getElementById('search-results-count').textContent =
            count === 0 ? 'No results' : `${count} result${count !== 1 ? 's' : ''}`;
    } catch(e) {
        console.error('Search error:', e);
        document.getElementById('search-results-count').textContent = 'Search failed';
    }
}

function clearSearch() {
    isSearchActive = false;
    document.getElementById('search-input').value = '';
    document.getElementById('search-clear').classList.add('hidden');
    document.getElementById('search-results-count').classList.add('hidden');
    loadMeetingHistory(); // restore full list
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FEATURE: SPEAKER LABELS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let currentSpeakerLabels = {}; // { "A": "Rahul", "B": "Priya" }
let currentModalMeetingId = null;
let pendingSpeakerMeetingId = null; // for post-upload popup

function extractSpeakersFromTranscript(transcript) {
    if (!transcript) return [];
    const matches = [...transcript.matchAll(/^([A-Z]):/gm)];
    return [...new Set(matches.map(m => m[1]))].sort();
}

function renderSpeakerLabels(speakers, labels) {
    const container = document.getElementById('speaker-labels-container');
    const saveBtn = document.getElementById('save-speakers-btn');
    container.innerHTML = '';

    if (!speakers.length) {
        container.innerHTML = '<p class="text-xs text-gray-500">No labeled speakers found in this transcript.</p>';
        return;
    }

    speakers.forEach(code => {
        const currentName = labels[code] || '';
        const pill = document.createElement('div');
        pill.className = 'flex items-center gap-2 bg-gray-800 border border-gray-600 rounded-lg px-3 py-1.5';
        pill.innerHTML = `
            <span class="text-xs font-bold text-indigo-400 w-5 text-center">${code}</span>
            <span class="text-gray-500 text-xs">‚Üí</span>
            <input data-speaker="${code}" type="text" value="${currentName}"
                placeholder="Enter name..."
                class="bg-transparent text-sm text-white placeholder-gray-500 focus:outline-none w-28"
                oninput="onSpeakerInputChange()"/>
        `;
        container.appendChild(pill);
    });

    saveBtn.classList.remove('hidden');
}

function onSpeakerInputChange() {
    // collect current values
    const inputs = document.querySelectorAll('#speaker-labels-container input[data-speaker]');
    inputs.forEach(inp => {
        const code = inp.dataset.speaker;
        currentSpeakerLabels[code] = inp.value.trim();
    });
}

async function saveSpeakerLabels() {
    if (!currentModalMeetingId) return;
    const saveBtn = document.getElementById('save-speakers-btn');
    saveBtn.textContent = 'Saving...';
    saveBtn.disabled = true;

    try {
        await fetch(`${API_BASE_URL}/meetings/${currentModalMeetingId}/speakers`, {
            method: 'PATCH',
            headers: { ...(getAuthHeaders() || {}), 'Content-Type': 'application/json' },
            body: JSON.stringify({ labels: currentSpeakerLabels })
        });

        // Update local allMeetings cache
        const m = allMeetings.find(m => m.meeting_id === currentModalMeetingId);
        if (m) m.speaker_labels = JSON.stringify(currentSpeakerLabels);

        // Re-render transcript with real names
        renderTranscriptWithNames(
            document.getElementById('modal-transcript')._rawTranscript || '',
            currentSpeakerLabels
        );

        saveBtn.textContent = '‚úì Saved!';
        setTimeout(() => { saveBtn.textContent = 'Save Names'; saveBtn.disabled = false; }, 1500);
    } catch(e) {
        saveBtn.textContent = 'Save Names';
        saveBtn.disabled = false;
        console.error('Save speakers failed:', e);
    }
}

function renderTranscriptWithNames(transcript, labels) {
    const el = document.getElementById('modal-transcript');
    el._rawTranscript = transcript; // store raw for re-render

    if (!transcript) {
        el.innerHTML = '<p class="text-gray-500">Transcript not available.</p>';
        return;
    }

    const lines = transcript.split('\n');
    el.innerHTML = lines.map(line => {
        // Match "A: text" pattern
        const m = line.match(/^([A-Z]):\s*(.*)/);
        if (m) {
            const code = m[1];
            const text = m[2];
            const name = labels[code] ? labels[code] : `Speaker ${code}`;
            const colorClass = ['text-indigo-400','text-green-400','text-yellow-400','text-pink-400','text-orange-400'][
                code.charCodeAt(0) % 5
            ];
            return `<div class="mb-1"><span class="font-bold ${colorClass} cursor-pointer hover:underline"
                onclick="focusSpeakerInput('${code}')" title="Click to rename">${name}</span>
                <span class="text-gray-300"> ${text}</span></div>`;
        }
        return `<div class="text-gray-400">${line}</div>`;
    }).join('');
}

function focusSpeakerInput(code) {
    const input = document.querySelector(`#speaker-labels-container input[data-speaker="${code}"]`);
    if (input) {
        input.focus();
        input.select();
        input.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
}

// Post-upload speaker popup
function showSpeakerPopup(meetingId, transcript) {
    pendingSpeakerMeetingId = meetingId;
    const speakers = extractSpeakersFromTranscript(transcript);
    if (!speakers.length) return;

    const fields = document.getElementById('speaker-popup-fields');
    fields.innerHTML = speakers.map(code => `
        <div class="flex items-center gap-3">
            <span class="text-sm font-bold text-indigo-400 w-20">Speaker ${code}</span>
            <input data-speaker="${code}" type="text" placeholder="Enter real name..."
                class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-3 py-1.5 text-sm text-white placeholder-gray-400 focus:outline-none focus:border-indigo-500"/>
        </div>
    `).join('');

    document.getElementById('speaker-popup').classList.remove('hidden');
}

async function saveSpeakerPopup() {
    const inputs = document.querySelectorAll('#speaker-popup-fields input[data-speaker]');
    const labels = {};
    inputs.forEach(inp => {
        if (inp.value.trim()) labels[inp.dataset.speaker] = inp.value.trim();
    });

    if (Object.keys(labels).length && pendingSpeakerMeetingId) {
        await fetch(`${API_BASE_URL}/meetings/${pendingSpeakerMeetingId}/speakers`, {
            method: 'PATCH',
            headers: { ...(getAuthHeaders() || {}), 'Content-Type': 'application/json' },
            body: JSON.stringify({ labels })
        });
        const m = allMeetings.find(m => m.meeting_id === pendingSpeakerMeetingId);
        if (m) m.speaker_labels = JSON.stringify(labels);
    }
    closeSpeakerPopup();
}

function closeSpeakerPopup() {
    document.getElementById('speaker-popup').classList.add('hidden');
    pendingSpeakerMeetingId = null;
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FEATURE: MEETING Q&A CHAT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let chatOpen = false;
let chatHistory = []; // {role, content}
let activeChatMeetingId = null;

function toggleChat() {
    chatOpen = !chatOpen;
    const panel = document.getElementById('chat-panel');
    const icon = document.getElementById('chat-fab-icon');
    const closeIcon = document.getElementById('chat-fab-close');

    panel.classList.toggle('hidden', !chatOpen);
    icon.classList.toggle('hidden', chatOpen);
    closeIcon.classList.toggle('hidden', !chatOpen);

    if (chatOpen) populateChatMeetingSelect();
}

function populateChatMeetingSelect() {
    const select = document.getElementById('chat-meeting-select');
    const completedMeetings = allMeetings.filter(m => m.status === 'COMPLETED');
    select.innerHTML = '<option value="">‚Äî Select a meeting ‚Äî</option>' +
        completedMeetings.map(m =>
            `<option value="${m.meeting_id}">${m.title}</option>`
        ).join('');
}

function onChatMeetingChange() {
    const meetingId = parseInt(document.getElementById('chat-meeting-select').value);
    if (!meetingId) return;

    activeChatMeetingId = meetingId;
    chatHistory = [];

    const meeting = allMeetings.find(m => m.meeting_id === meetingId);
    const messagesEl = document.getElementById('chat-messages');

    let labels = {};
    if (meeting?.speaker_labels) {
        try { labels = JSON.parse(meeting.speaker_labels); } catch(e) {}
    }
    const speakerNames = Object.values(labels);
    const speakerNote = speakerNames.length
        ? `<span class="text-indigo-400">Speakers: ${speakerNames.join(', ')}</span> ¬∑ `
        : '';

    messagesEl.innerHTML = `
        <div class="bg-gray-700/50 rounded-lg p-3 text-xs text-gray-300">
            ${speakerNote}Ask anything about this meeting ‚Äî decisions, action items, what someone said.
        </div>`;

    document.getElementById('chat-input').focus();
}

function appendChatMessage(role, text) {
    const el = document.getElementById('chat-messages');
    const isUser = role === 'user';
    const div = document.createElement('div');
    div.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;
    div.innerHTML = `
        <div class="max-w-[80%] px-3 py-2 rounded-xl text-sm leading-relaxed
            ${isUser
                ? 'bg-indigo-600 text-white rounded-br-none'
                : 'bg-gray-700 text-gray-200 rounded-bl-none'}">
            ${text.replace(/\n/g, '<br>')}
        </div>`;
    el.appendChild(div);
    el.scrollTop = el.scrollHeight;
}

function appendChatTyping() {
    const el = document.getElementById('chat-messages');
    const div = document.createElement('div');
    div.id = 'chat-typing';
    div.className = 'flex justify-start';
    div.innerHTML = `<div class="bg-gray-700 px-4 py-2 rounded-xl rounded-bl-none text-gray-400 text-sm">
        <span class="animate-pulse">Thinking...</span></div>`;
    el.appendChild(div);
    el.scrollTop = el.scrollHeight;
}

async function sendChatMessage() {
    const input = document.getElementById('chat-input');
    const sendBtn = document.getElementById('chat-send-btn');
    const q = input.value.trim();
    if (!q || !activeChatMeetingId) return;

    input.value = '';
    sendBtn.disabled = true;

    appendChatMessage('user', q);
    chatHistory.push({ role: 'user', content: q });
    appendChatTyping();

    try {
        const resp = await fetch(`${API_BASE_URL}/meetings/${activeChatMeetingId}/chat`, {
            method: 'POST',
            headers: { ...(getAuthHeaders() || {}), 'Content-Type': 'application/json' },
            body: JSON.stringify({ meeting_id: activeChatMeetingId, messages: chatHistory })
        });
        const data = await resp.json();
        const answer = data.answer || 'Sorry, I could not generate a response.';

        document.getElementById('chat-typing')?.remove();
        appendChatMessage('assistant', answer);
        chatHistory.push({ role: 'assistant', content: answer });
    } catch(e) {
        document.getElementById('chat-typing')?.remove();
        appendChatMessage('assistant', '‚ö†Ô∏è Error connecting to server.');
    } finally {
        sendBtn.disabled = false;
        input.focus();
    }
}


// --- AUTHENTICATION FUNCTIONS ---
function logout() {
    // Clear tokens from storage
    localStorage.removeItem('auth_token');
    localStorage.removeItem('user_email');
    sessionStorage.removeItem('auth_token');
    sessionStorage.removeItem('user_email');
    
    // Redirect to login page
    window.location.href = '/login.html';
}

// Check authentication on page load
function checkAuth() {
    const token = localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token');
    if (!token) {
        // Redirect to login if not authenticated
        window.location.href = '/login.html';
    }
}

// Call checkAuth when page loads
checkAuth();

</script>
<!-- ‚îÄ‚îÄ SPEAKER LABEL POPUP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="speaker-popup" class="hidden fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4">
    <div class="bg-gray-800 rounded-xl p-6 w-full max-w-sm shadow-2xl border border-gray-600">
        <h3 class="text-lg font-bold text-white mb-1">Label Speakers</h3>
        <p class="text-xs text-gray-400 mb-4">Give each speaker a real name. You can edit these later in the modal.</p>
        <div id="speaker-popup-fields" class="space-y-3 mb-4"></div>
        <div class="flex gap-3">
            <button onclick="saveSpeakerPopup()" class="flex-1 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-bold">Save</button>
            <button onclick="closeSpeakerPopup()" class="flex-1 py-2 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded-lg text-sm">Skip</button>
        </div>
    </div>
</div>

<!-- ‚îÄ‚îÄ FLOATING Q&A CHAT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="chat-fab" onclick="toggleChat()"
    class="fixed bottom-6 right-6 z-50 w-14 h-14 bg-indigo-600 hover:bg-indigo-700 rounded-full shadow-xl flex items-center justify-center cursor-pointer transition-transform hover:scale-110">
    <svg id="chat-fab-icon" class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
    </svg>
    <span id="chat-fab-close" class="hidden text-white text-xl font-bold leading-none">‚úï</span>
</div>

<div id="chat-panel" class="hidden fixed bottom-24 right-6 z-50 w-96 bg-gray-800 rounded-2xl shadow-2xl border border-gray-600 flex flex-col" style="max-height: 520px;">
    <!-- Header -->
    <div class="p-4 border-b border-gray-700 flex-shrink-0">
        <p class="text-xs font-semibold text-indigo-400 uppercase tracking-wide mb-1">Meeting Q&A</p>
        <select id="chat-meeting-select" onchange="onChatMeetingChange()"
            class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-1.5 text-sm text-white focus:outline-none focus:border-indigo-500">
            <option value="">‚Äî Select a meeting ‚Äî</option>
        </select>
    </div>
    <!-- Messages -->
    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3 text-sm"></div>
    <!-- Input -->
    <div class="p-3 border-t border-gray-700 flex gap-2 flex-shrink-0">
        <input id="chat-input" type="text" placeholder="Ask anything about this meeting..."
            class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-400 focus:outline-none focus:border-indigo-500"
            onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();sendChatMessage();}"/>
        <button onclick="sendChatMessage()" id="chat-send-btn"
            class="px-3 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-white text-sm font-bold transition">
            ‚û§
        </button>
    </div>
</div>

</body>
</html>